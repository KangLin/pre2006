<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>WinPcap: 过滤串表达式的语法</title>
<link href="style.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<!-- Translated By CoffeeCat (Chinese)-->
<!-- http://www.CoffeeCat.net.cn-->
<div class="tabs">
  <ul>
    <li id="current"><a href="main.html"><span>主 页</span></a></li>
    <li><a href="modules.html"><span>模块</span></a></li>
    <li><a href="annotated.html"><span>数据结构</span></a></li>
    <li><a href="files.html"><span>文件</span></a></li>
    <li><a href="pages.html"><span>相关页面</span></a></li>
  </ul></div>
<h1>过滤串表达式的语法<br>
<small>
[<a class="el" href="group__wpcap.html">WinPcap用户指南</a>]</small>
</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<title></title>
</head>

<body>
<DL COMPACT>
<DT>注意：这篇文档取自tcpdump的指南。原始的版本 <a href="http://www.tcpdump.org">www.tcpdump.org</a> 找到。
<dd>&nbsp;</dd>
<DT>wpcap的过滤器是以已声明的谓词语法为基础的。过滤器是一个ASCII字符串，它包含了一个过滤表达式。pcap_compile()把这个表达式编译成内核级的包过滤器。</DL>
<p>这个表达式会选择那些数据包将会被堆存。如果表达式没有给出，那么，网络上所有的包都会被内核过滤引擎所认可。不然，只有那些表达式为'true'的包才会被认可。</p>
<P>

这个表达式包含了一个或多个原语。原语通常包含了<i>id</i>(名字或序列)，这些id优先于限定词。以下是三种不同的限定词：<DL COMPACT>
<DT><I>输入(type)</I>
<DD>
指明了哪些东西是id所代表的。可能的输入是<B>host</B>，<B>net</B>和<B>port</B>。比如：`host foo'，`net 128.3'，`port 20'。如果没有输入限定词，就假定是<B>host</B>
<DT><I>方向(dir)</I><DD>
由id指明了一个特定的传输方向。可能的方向是<B>src</B>，<B>dst</B>，<B>src or dst</B>。比如，'src foo'，'dst net 128.3'，`src or dst port ftp-data'。如果没有指定，就假定是<B>src or dst</B>。如果没有链路层(比如，像slip这样的点对点协议)，那么限定词可以使用<B>inbound</B>和<B>outbound</B>，来指明一个方向。
<DT><I>协议(proto)</I><DD>
限定词限制了所匹配的协议。可能的协议有：<B>ether</B>，<B>fddi</B>，<B>tr</B>，<B>ip</B>，<B>ip6</B>，<B>arp</B>，<B>rarp</B>，<B>decnet</B>，<B>tcp</B>和<B>udp</B>。比如：`ether src foo'，`arp net 128.3'，`tcp port 21'。如果没有指定协议限定词，那么就假定所有的协议都会被允许。例如：'src foo'等价于'(ip or arp or rarp)src foo'(当然，不能有不符合语法的字母出现)，'net bar'等价于'(ip or arp or rarp) net bar'，'port53'等价于'(tcp or udp) port 53'。</DL>
<P>

[ 'fddi'通常是'ether'的别名；解析器会认为它们是在特定网络接口上的数据链路层。FDDI的首部包含了和以太网很相似的源地址和目的地址，并且通常也包含了和以太网很相似的数据包类型。所以，在FDDI网域上使用过滤器和在以太网上使用过滤器基本一致。FDDI的首部还包括了其他的数据，不过你不能在过滤器表达式内表示他们。
<P>

同样的，'tr'也是'ether'的一个别名，它是较早被应用于FDDI的首部，也应用在令牌环网络首部。]
<P>

除了以上内容，还有一些特殊的限定词和上面的形式不太一样，它们是：<B>gateway</B>，<B>broadcast</B>，<B>less</B>，<B>greater</B>和一些算术表达式。这些内容会在下面和大家介绍。
<P>

我们可以使用<B>and</B>，<B>or</B>和<B>not</B>将原语连接起来，来构造一个更复杂的过滤表达式。例如：`host foo and not port ftp and not port ftp-data'。如果要简化输入，我们可以把已列出的id限定词省略。比如：`tcp dst port ftp or ftp-data or domain' 和 `tcp dst port ftp or tcp dst port ftp-data or tcp dst port domain'是完全等价的。
<P>

可使用的原语有：
<DL COMPACT>
<DT><B>dst host </B><I>host</I>
<DD>
当IPv4/v6数据包的目标域(destination field)为<i>host</i>时为true，<i>host</i>既可以是地址，也可以是名字。
<DT><B>src host </B><I>host</I>
<DD>
当IPv4/v6数据包的源域(source field)为<i>host</i>时为true。
<DT><B>host </B><I>host</I>
<DD>
当IPv4/v6数据包的源域(source field)或目标域(destination field)为<i>host</i>时为true。以上任何一个host表达式可以是<B>ip</B>，<B>arp</B>，<B>rarp</B>或<B>ip6</B>开头，如下所示：
<dl COMPACT>
  <dd>

<PRE><B>ip host </B><I>host</I></PRE>


  </dd>
</dl>


等价于：
<dl COMPACT>
  <dd>

<PRE><B>ether proto </B><I>\ip</I><B> and host </B><I>host</I></PRE>


  </dd>
</dl>


如果<i>host</i>是一个多IP地址，那么每一个地址都会被匹配。<DT><B>ether dst </B><I>ehost</I>
<DD>
当以太网的目的地址为<i>ehost</i>时为true。<i>ehost</i>可以是一个来自/etc/ether的名字，也可以是一个数字代号(参见 <I>ethers</I>(3N)for numeric format)。
<DT><B>ether src </B><I>ehost</I>
<DD>
当以太网的源地址为<i>ehost</i>时为true。
<DT><B>ether host </B><I>ehost</I>
<DD>
当以太网的目的地址，或源地址为<i>ehost</i>时为true。
<DT><B>gateway</B> <I>host</I><DD>
当<i>host</i>为网关时为true。即，以太网源地址或目的地址是<i>host</i>,但源地址和目的地址不同时为<i>host</i>。<i>host</i>必须能被机器的主机-IP地址(host-name-to-IP-address)机制找到(如主机名文件，DNS，NIS等)，也能被主机-以太网地址(host-name-to-Ethernet-address)机制找到(如/etc/ethers等)。例如：
<dl COMPACT>
  <dd>

<PRE><B>ether host </B><I>ehost </I><B>and not host </B><I>host</I></PRE>


  </dd>
</dl>


<I>host / ehost</I>均可使用名字或数字。这个语法目前在IPv6下不能工作。
<DT><B>dst net </B><I>net</I><DD>
当IPv4/v6数据包的目的地址的网络号包含了<i>net</i>时为true。<i>net</i>可以是一个来自/etc/networks的名字，也可以是一个网络号(更多内容请参见 <i>networks(4)</i>)。
<DT><B>src net </B><I>net</I><DD>
当IPv4/v6数据包的源地址的网络号包含了<i>net</i>时为true。
<DT><B>net </B><I>net</I><DD>
当IPv4/v6数据包的目的地址，或源地址的网络号包含了<i>net</i>时为true
<DT><B>net </B><I>net</I> <B>mask </B><I>netmask</I><DD>
当IP地址是 <I>net</I> ，子网掩码匹配 <I>netmask</I> 时为true。
可能需要 <B>src</B> 或 <B>dst</B>加以限制。
注意，这个语法不能应用于IPv6。
<DT><B>net </B><I>net</I>/<I>len</I><DD>
当IP地址是 <I>net</I> ，子网掩码连续1的个数为 <I>len</I> 时为true。
可能需要 <B>src</B> 或 <B>dst</B>加以限制。
<DT><B>dst port </B><I>port</I><DD>
当数据包是ip/tcp, ip/udp, ip6/tcp 或 ip6/udp，并且目的端口号是<i>port</i>时为true。<i>port</i>可以是数字，或是在/etc/services中被使用的名字。(参见 <i>tcp(4P) and udp(4P)</i>)。如果使用名字，那么端口号和协议都将被检测。如果使用数字，或者一个不明确的名字，那么只有端口号会被检测。（比如：<B>dst port 513</B>将打印tcp/login数据流和udp/who数据流。<B>port domain</B>将打印tcp/domain的数据流和udp/domain的数据流）。
<DT><B>src port </B><I>port</I><DD>
当源端口号是 <I>port</I>时为true。
<DT><B>port </B><I>port</I><DD>
当源端口号或目的端口号为 <i>port</i> 时为true。以上任何一个port表达式可以以关键字<b>tcp</b>或<b>udp</b>开头，如下所示： <dl COMPACT>
  <dd>

<PRE><B>tcp src port </B><I>port</I></PRE>


  </dd>
</dl>


只匹配源端口是 <I>port</I> 的tcp数据包。
<DT><B>less </B><I>length</I><DD>
当数据包的长度小于等于<I>length</I>时为true。即：
<dl COMPACT>
  <dd>

<PRE><B>len &lt;= </B><I>length</I>.</PRE>


  </dd>
</dl>


<DT><B>greater </B><I>length</I><DD>
当数据包的长度大于等于<I>length</I>时为true。即：
<dl COMPACT>
  <dd>

<PRE><B>len &gt;= </B><I>length</I>.</PRE>


  </dd>
</dl>


<DT><B>ip proto </B><I>protocol</I><DD>
当数据包是IP数据包，并且它的协议类型为<I>protocol</I>时为true。<I>protocol</I>可以是一个数字，也可以是<I>icmp</I>, <I>icmp6</I>，<I>igmp</I>，<I>igrp</I>，<I>pim</I>，<I>ah</I>，<I>esp</I>，<I>vrrp</I>，<I>udp</I> 或 <I>tcp</I>中的一个。注意，<I>tcp</I>，<I>udp</I>， <I>icmp</I>是关键字，所以，它们要使用反斜杠(\)来转义，就好比C-shell中的\\。注意，这个原语不会去追踪协议首部链。
<DT><B>ip6 proto </B><I>protocol</I><DD>
当数据包是IPv6数据包，并且它的协议类型为<I>protocol</I>时为true。注意，这个原语不会去追踪协议首部链。

<DT><B>ip6 protochain </B><I>protocol</I><DD>
当数据包是IPv6数据包，并且，在它的协议首部链中，包含了<I>protocol</I>类型的协议首部时，为true。
例如：
<dl COMPACT>
  <dd>

<PRE><B>ip6 protochain 6</B></PRE>


  </dd>
</dl>


能匹配所有的，拥有TCP协议首部的IPv6的数据包。在IPv6首部和TCP首部之间，可能包含认证首部，路由首部和跳数选项首部。由这个原语所生成的BPF(BSD Packet Filter，包过滤机制)码是复杂的，而且不能被BPF优化器优化，所以，在某些程度上，它的速度比较慢。<DT><B>ip protochain </B><I>protocol</I><DD>
功能和 <B>ip6 protochain </B><I>protocol</I>相同，只是这个应用于 IPv4。
<DT><B>ether broadcast</B>
<DD>
当数据包是以太网广播数据包时为true。关键字<I>ether</I>是可选的。
<DT><B>ip broadcast</B><DD>
当数据包是IP广播数据包时为true。它会检查所有的广播，包括地址全是0的和地址全是1的，然后，检查子网掩码。

<DT><B>ether multicast</B><DD>
当数据包是以太网多播数据包时为true。关键字ether是可选的。 下面是一个常用短语`<B>ether[0] &amp; 1 != 0</B>'
<DT><B>ip multicast</B><DD>
当数据包是IP多播数据包时为true。
<DT><B>ip6 multicast</B><DD>
当数据包是IPv6多播数据包时为true。
<DT><B>ether proto </B><I>protocol</I><DD>
当数据包是以太类型的<I>protocol</I>时为true。<I>protocol</I>可以是一个数字，也可以是<I>ip</I>, <I>ip6</I>, <I>arp</I>, <I>rarp</I>, <I>atalk</I>, <I>aarp</I>,<I>decnet</I>, <I>sca</I>, <I>lat</I>, <I>mopdl</I>, <I>moprc</I>,<I>iso</I>, <I>stp</I>, <I>ipx</I>, <I>netbeui</I>中的一个。注意，这些符号也都是关键字，所以，他们都需要用反斜杠(\)转义。
<DT><DD>
[在使用FDDI(比如'<B>fddi protocol arp</B>')和令牌环(比如'<B>tr protocol arp</B>')和其他大多数这种协议时，协议根据802.2逻辑链路控制(LLC)来识别，这些信息通常在FDDI或令牌环首部的开始。
<DT>
<DD>
当需要识别大多数协议的标识，比如FDDI或令牌环时, <i>Tcpdump</i>只检查LLC报头的ID数据域，它们以SNAP格式存储，并且，组织单位识别码(Organizational Unit Identifier(OUI))为0x000000，以封装以太网。它不会检查这个包是不是SNAP格式的，并在0x000000单元有OUI。
<DT><DD>
然而，<i>iso</i>是个特例，它会检查LLC首部的目的服务存取点DSAP(Destination Service Access Point)和源服务存取点SSAP(Source Service Access Point)，<i>stp</i>和<i>netbeui</i>会检查LLC首部的DSAP，<i>atalk</i>会检查数据包是不是SNAP格式的，并且OUI是不是0x080007。Appletalk 同样如此。
<DT><DD>
在以太网的例子中，<i>tcpdump</i>检查大部分协议的以太网类型字段，<I>iso</I>，<I>sap</I> 和 <I>netbeui</I>除外，因为它们会检查802.3帧，然后检查LLC首部，就像它对FDDI和令牌环那样。<i>atalk</i>，它检查以太网帧的Appletalk etype和SNAP格式的以太网帧，<i>arrp</i>，它在以太网帧中检查Appletalk ARP etype，或是在OUI为0x000000的802.2 SNAP帧中查找，还有ipx，他会在以太网帧中检查IPX etype，在LLC首部检查IPX DSAP，没有用802.3封装的LLC首部的IPX，和SNAP帧中的IPX etype。]
<DT><B>decnet src </B><I>host</I><DD>
当DECNET的源地址为<i>host</i>时为true，它可能是一个格式为'10.123'的地址，也可能是一个DECNET主机名。[DECNET主机名称只有在配置成可运行DECNET的Ultrix系统中才得到支持。]
<DT><B>decnet dst </B><I>host</I>
<DD>
当DECNET的目的地址为<i>host</i>时为true。
<DT><B>decnet host </B><I>host</I><DD>
当DECNET的源地址或目的地址为<i>host</i>时为true。
<DT><B>ip</B>, <B>ip6</B>, <B>arp</B>, <B>rarp</B>, <B>atalk</B>, <B>aarp</B>, <B>decnet</B>, <B>iso</B>, <B>stp</B>, <B>ipx</B>, <I>netbeui</I><DD>
缩写是：
<dl COMPACT>
  <dd>

<PRE><B>ether proto </B><I>p</I></PRE>


  </dd>
</dl>


<I>p</I> 是以上协议中的一个。
<DT><B>lat</B>, <B>moprc</B>, <B>mopdl</B><DD>
缩写是：
<dl COMPACT>
  <dd>

<PRE><B>ether proto </B><I>p</I></PRE>


  </dd>
</dl>


<I>p</I> 是以上协议中的一个。
注意：
<I>tcpdump</I> 目前并不知道，如何解析出这些协议。
<DT><B>vlan </B><I>[vlan_id]</I><DD>
当数据包是IEEE 802.1Q VLAN数据包时为true。若[<i>vlan_id</i>]被指定，则仅当数据包为指定的vlan_id，值才为true。注意，在假设数据包为VLAN数据包的前提下，表达式中的第一个关键字<b>vlan</b>会改变剩余表达式的解码偏移量。
<DT><B>tcp</B>, <B>udp</B>, <B>icmp</B><DD>
缩写是：
<dl COMPACT>
  <dd>

<PRE><B>ip proto </B><I>p</I><B> or ip6 proto </B><I>p</I></PRE>


  </dd>
</dl>


<I>p</I> 是以上协议中的一个。
<DT><B>iso proto </B><I>protocol</I><DD>
当数据包的协议类型为<i>protocol</i>的OSI数据包时值为true。<i>Protocol</i>可以是一个数字或以下名称中的一个：<I>clnp</I>，<I>esis</I>或<I>isis</I>。 
<DT><B>clnp</B>, <B>esis</B>, <B>isis</B><DD>
缩写是：
<dl COMPACT>
  <dd>

<PRE><B>iso proto </B><I>p</I></PRE>


  </dd>
</dl>


<I>p</I> 是以上协议中的一个。注意，<i>tcpdump</i>并不能完成这些协议的全部解析工作。
<DT><I>expr relop expr</I>
<DD>
若关系式如下：<i>relop</i>是 &gt;, &lt;, &gt;=, &lt;=, =, != 中的一个，并且<i>expr</i>是一个由正整常数（用标准C语言的语法表示），标准二进制运算符[ +, -, *, /, &amp;, | ]，运算符的长度，和指定数据包存取，则值为true。要存取数据包内的数据，可以使用以下的语法： 

<PRE>
<I>proto</I><B> [ </B><I>expr</I><B> : </B><I>size</I><B> ]</B>
</PRE>


<I>Proto</I> 是 <B>ether, fddi, tr, ip, arp, rarp, tcp, udp, icmp</B> or <B>ip6</B>中的一个，它为索引操作指明了协议层。注意，<i>tcp,udp</i>和其他较高层的协议类型只能应用于IPv4，而不能用于IPv6(这个问题可能在将来能得到解决)。被指定的协议层的字节偏移量由<i>expr</i>给出。<i>Size</i>是可选的，它指明了数据域中，我们所感兴趣的字节数。它可以是1，2，或4，默认为1。运算符的长度，由关键字<b>len</b>给出，指明了数据包的长度。
<P>
例如，`<B>ether[0] &amp; 1 != 0</B>'会捕捉所有的多播数据流。表达式`<B>ip[0] &amp; 0xf != 5</B>'能捕捉所有带可选域的IP数据包。表达式`<B>ip[6:2] &amp; 0x1fff = 0</B>'仅捕捉未分段的数据报和段偏移量是0的数据报。这个检查隐含在<b>tcp</b>和<b>udp</b>的下标操作中。例如，tcp[0]通常指第一个字节的TCP首部，而不是指第一个字节的分段。
<P>
有些偏移量和域值可以以名字来表示，而不是数值。以下协议首部域的偏移量是正确的：<B>icmptype</B> (ICMP 类型域), <B>icmpcode</B> (ICMP 代码域), and <B>tcpflags</B> (TCP 标志域)。<P>
ICMP 类型域有以下这些： <B>icmp-echoreply</B>,
<B>icmp-unreach</B>, <B>icmp-sourcequench</B>, <B>icmp-redirect</B>,
<B>icmp-echo</B>, <B>icmp-routeradvert</B>, <B>icmp-routersolicit</B>,
<B>icmp-timxceed</B>, <B>icmp-paramprob</B>, <B>icmp-tstamp</B>,
<B>icmp-tstampreply</B>, <B>icmp-ireq</B>, <B>icmp-ireqreply</B>,
<B>icmp-maskreq</B>, <B>icmp-maskreply</B>.
<P>
TCP 标志域有以下这些： <B>tcp-fin</B>,
<B>tcp-syn</B>, <B>tcp-rst</B>, <B>tcp-push</B>, <B>tcp-push</B>,
<B>tcp-ack</B>, <B>tcp-urg</B>.
</DL>
<P>

原语可以用以下内容组合：
<DL COMPACT>
<DT><DD>
用圆括号括起来的原语和操作符
(圆括号在Shell中是特殊符号，所以必须要转义)。
<DT><DD>
取反操作 (`<B>!</B>' 或 `<B>not</B>').
<DT><DD>
连接操作 (`<B>&amp;&amp;</B>' 或 `<B>and</B>').
<DT><DD>
选择操作 (`<B>||</B>' 或 `<B>or</B>').
</DL>
<P>

取反操作的优先级最高。
连接操作和选择操作有相同的优先级，并且它们的结合方向为从左向右。
注意：做连接的时候是需要显示的 <B>and</B> 操作符的，而不是把要连接的东西写在一起。
<P>

如果给出一个标识符，却没有关键字，那么就会假定用最近使用的关键字。
例如：

<blockquote>

<PRE><B>not host vs and ace</B></PRE>


</blockquote>


等价于
<blockquote>

<PRE><B>not host vs and host ace</B></PRE>


</blockquote>


不能和下面的混淆
<blockquote>

<PRE><B>not ( host vs or ace )</B></PRE>


</blockquote>


<P>

表达式参数即可以作为单个参数，也可以作为多个参数传递给<i>tcpdump</i>，后者更加方便一些。一般的，如果表达式包含一个Shell的元字符，那么用一个参数传递比较容易，最好把它括起来，多个参数在传递前，用空格连接起来。<p>

</body>

</html>
 
<hr>
<p align="right"><img border="0" src="winpcap_small.gif" align="absbottom" width="91" height="27">
documentation. Copyright (c) 2002-2005 Politecnico di Torino. Copyright (c) 2005-2007 
CACE Technologies. All rights reserved.
<br>2007 Translated By <a href="http://www.CoffeeCat.net.cn" target="_blank">CoffeeCat Studio</a>
</p>
