<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>WinPcap: 获取已安装设备的高级信息</title>
<link href="style.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<!-- Translation(Chinese) By CoffeeCat -->
<!-- http://www.CoffeeCat.net.cn-->
<div class="tabs">
  <ul>
    <li id="current"><a href="main.html"><span>主 页</span></a></li>
    <li><a href="modules.html"><span>模块</span></a></li>
    <li><a href="annotated.html"><span>数据结构</span></a></li>
    <li><a href="files.html"><span>文件</span></a></li>
    <li><a href="pages.html"><span>相关页面</span></a></li>
  </ul></div>
<h1>获取已安装设备的高级信息</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
在第1讲中， (<a class="el" href="group__wpcap__tut1.html">获取设备列表</a>) 我们展示了如何获取适配器的基本信息 (如设备的名称和描述)。 事实上，WinPcap提供了其他更高级的信息。 特别需要指出的是， 由 <a class="el" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex()</a> 返回的每一个 <a class="el" href="structpcap__if.html">pcap_if</a> 结构体，都包含一个 <a class="el" href="structpcap__addr.html">pcap_addr</a> 结构体，这个结构体由如下元素组成：<ul>
<li>一个地址列表</li><li>一个掩码列表 (each of which corresponds to an entry in the addresses list).</li><li>一个广播地址列表 (each of which corresponds to an entry in the addresses list).</li><li>一个目的地址列表 (each of which corresponds to an entry in the addresses list).</li></ul>
<p>
另外，函数 <a class="el" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex()</a> 还能返回远程适配器信息和一个位于所给的本地文件夹的pcap文件列表。<p>
下面的范例使用了ifprint()函数来打印出 <a class="el" href="structpcap__if.html">pcap_if</a> 结构体中所有的内容。程序对每一个由 <a class="el" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex()</a> 函数返回的pcap_if，都调用ifprint()函数来实现打印。<p>
<div class="fragment"><pre class="fragment"><span class="comment">/*</span>
<span class="comment"> * Copyright (c) 1999 - 2005 NetGroup, Politecnico di Torino (Italy)</span>
<span class="comment"> * Copyright (c) 2005 - 2006 CACE Technologies, Davis (California)</span>
<span class="comment"> * All rights reserved.</span>
<span class="comment"> *</span>
<span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<span class="comment"> * modification, are permitted provided that the following conditions</span>
<span class="comment"> * are met:</span>
<span class="comment"> *</span>
<span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<span class="comment"> * notice, this list of conditions and the following disclaimer.</span>
<span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<span class="comment"> * notice, this list of conditions and the following disclaimer in the</span>
<span class="comment"> * documentation and/or other materials provided with the distribution.</span>
<span class="comment"> * 3. Neither the name of the Politecnico di Torino, CACE Technologies </span>
<span class="comment"> * nor the names of its contributors may be used to endorse or promote </span>
<span class="comment"> * products derived from this software without specific prior written </span>
<span class="comment"> * permission.</span>
<span class="comment"> *</span>
<span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="comment"> * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="comment"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="comment"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="comment"> *</span>
<span class="comment"> */</span>

<span class="preprocessor">#include "pcap.h"</span>

<span class="preprocessor">#ifndef WIN32</span>
<span class="preprocessor"></span><span class="preprocessor">    #include &lt;sys/socket.h&gt;</span>
<span class="preprocessor">    #include &lt;netinet/in.h&gt;</span>
<span class="preprocessor">#else</span>
<span class="preprocessor"></span><span class="preprocessor">    #include &lt;winsock.h&gt;</span>
<span class="preprocessor">#endif</span>
<span class="preprocessor"></span>

<span class="comment">// 函数原型</span>
<span class="keywordtype">void</span> ifprint(<a class="code" href="structpcap__if.html">pcap_if_t</a> *d);
<span class="keywordtype">char</span> *iptos(u_long in);
<span class="keywordtype">char</span>* ip6tos(<span class="keyword">struct</span> sockaddr *sockaddr, <span class="keywordtype">char</span> *address, <span class="keywordtype">int</span> addrlen);


<span class="keywordtype">int</span> main()
{
  <a class="code" href="structpcap__if.html">pcap_if_t</a> *alldevs;
  <a class="code" href="structpcap__if.html">pcap_if_t</a> *d;
  <span class="keywordtype">char</span> errbuf[<a class="code" href="group__wpcap__def.html#gcd448353957d92c98fccc29e1fc8d927">PCAP_ERRBUF_SIZE</a>+1];
  <span class="keywordtype">char</span> source[<a class="code" href="group__wpcap__def.html#gcd448353957d92c98fccc29e1fc8d927">PCAP_ERRBUF_SIZE</a>+1];

  printf(<span class="stringliteral">"Enter the device you want to list:\n"</span>
            <span class="stringliteral">"rpcap://              ==&gt; lists interfaces in the local machine\n"</span>
            <span class="stringliteral">"rpcap://hostname:port ==&gt; lists interfaces in a remote machine\n"</span>
            <span class="stringliteral">"                          (rpcapd daemon must be up and running\n"</span>
            <span class="stringliteral">"                           and it must accept 'null' authentication)\n"</span>
            <span class="stringliteral">"file://foldername     ==&gt; lists all pcap files in the give folder\n\n"</span>
            <span class="stringliteral">"Enter your choice: "</span>);

  fgets(source, <a class="code" href="group__wpcap__def.html#gcd448353957d92c98fccc29e1fc8d927">PCAP_ERRBUF_SIZE</a>, stdin);
  source[<a class="code" href="group__wpcap__def.html#gcd448353957d92c98fccc29e1fc8d927">PCAP_ERRBUF_SIZE</a>] = <span class="charliteral">'\0'</span>;

  <span class="comment">/* 获得接口列表 */</span>
  <span class="keywordflow">if</span> (<a class="code" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex</a>(source, NULL, &amp;alldevs, errbuf) == -1)
  {
    fprintf(stderr,<span class="stringliteral">"Error in pcap_findalldevs: %s\n"</span>,errbuf);
    exit(1);
  }

  <span class="comment">/* 扫描列表并打印每一项 */</span>
  <span class="keywordflow">for</span>(d=alldevs;d;d=d-&gt;<a class="code" href="structpcap__if.html#81508e6e4e41ca4235c8d6b51913c536">next</a>)
  {
    ifprint(d);
  }

  <a class="code" href="group__wpcapfunc.html#g346b4b0b7fd1cda4abb9a39f767dbeb1">pcap_freealldevs</a>(alldevs);

  <span class="keywordflow">return</span> 1;
}



<span class="comment">/* 打印所有可用信息 */</span>
<span class="keywordtype">void</span> ifprint(<a class="code" href="structpcap__if.html">pcap_if_t</a> *d)
{
  <a class="code" href="structpcap__addr.html">pcap_addr_t</a> *a;
  <span class="keywordtype">char</span> ip6str[128];

  <span class="comment">/* 设备名(Name) */</span>
  printf(<span class="stringliteral">"%s\n"</span>,d-&gt;<a class="code" href="structpcap__if.html#5ac083a645d964373f022d03df4849c8">name</a>);

  <span class="comment">/* 设备描述(Description) */</span>
  <span class="keywordflow">if</span> (d-&gt;<a class="code" href="structpcap__if.html#8444d6e0dfe2bbab0b5e7b24308f1559">description</a>)
    printf(<span class="stringliteral">"\tDescription: %s\n"</span>,d-&gt;<a class="code" href="structpcap__if.html#8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);

  <span class="comment">/* Loopback Address*/</span>
  printf(<span class="stringliteral">"\tLoopback: %s\n"</span>,(d-&gt;<a class="code" href="structpcap__if.html#304e038dd1326c14b31a206cbad18756">flags</a> &amp; <a class="code" href="group__wpcap__def.html#g43a6601bfd438efc02b0ba71c5439647">PCAP_IF_LOOPBACK</a>)?<span class="stringliteral">"yes"</span>:<span class="stringliteral">"no"</span>);

  <span class="comment">/* IP addresses */</span>
  <span class="keywordflow">for</span>(a=d-&gt;<a class="code" href="structpcap__if.html#3910004677550db6d9b09792ba3e2cca">addresses</a>;a;a=a-&gt;<a class="code" href="structpcap__addr.html#b151e8e96bdb23ae8dd8d644de561999">next</a>) {
    printf(<span class="stringliteral">"\tAddress Family: #%d\n"</span>,a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>-&gt;sa_family);
  
    <span class="keywordflow">switch</span>(a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>-&gt;sa_family)
    {
      <span class="keywordflow">case</span> AF_INET:
        printf(<span class="stringliteral">"\tAddress Family Name: AF_INET\n"</span>);
        <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>)
          printf(<span class="stringliteral">"\tAddress: %s\n"</span>,iptos(((<span class="keyword">struct</span> sockaddr_in *)a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>)-&gt;sin_addr.s_addr));
        <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structpcap__addr.html#c43963e42e4d901e55e433ab9c3ea686">netmask</a>)
          printf(<span class="stringliteral">"\tNetmask: %s\n"</span>,iptos(((<span class="keyword">struct</span> sockaddr_in *)a-&gt;<a class="code" href="structpcap__addr.html#c43963e42e4d901e55e433ab9c3ea686">netmask</a>)-&gt;sin_addr.s_addr));
        <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structpcap__addr.html#0077647e1560caa72d457120b36c248c">broadaddr</a>)
          printf(<span class="stringliteral">"\tBroadcast Address: %s\n"</span>,iptos(((<span class="keyword">struct</span> sockaddr_in *)a-&gt;<a class="code" href="structpcap__addr.html#0077647e1560caa72d457120b36c248c">broadaddr</a>)-&gt;sin_addr.s_addr));
        <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structpcap__addr.html#4a32e00e83d4b1b582ba9cef24a5d62a">dstaddr</a>)
          printf(<span class="stringliteral">"\tDestination Address: %s\n"</span>,iptos(((<span class="keyword">struct</span> sockaddr_in *)a-&gt;<a class="code" href="structpcap__addr.html#4a32e00e83d4b1b582ba9cef24a5d62a">dstaddr</a>)-&gt;sin_addr.s_addr));
        <span class="keywordflow">break</span>;

      <span class="keywordflow">case</span> AF_INET6:
        printf(<span class="stringliteral">"\tAddress Family Name: AF_INET6\n"</span>);
        <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>)
          printf(<span class="stringliteral">"\tAddress: %s\n"</span>, ip6tos(a-&gt;<a class="code" href="structpcap__addr.html#4863f5b8767cd19fe6ea4db75456e5df">addr</a>, ip6str, <span class="keyword">sizeof</span>(ip6str)));
       <span class="keywordflow">break</span>;

      <span class="keywordflow">default</span>:
        printf(<span class="stringliteral">"\tAddress Family Name: Unknown\n"</span>);
        <span class="keywordflow">break</span>;
    }
  }
  printf(<span class="stringliteral">"\n"</span>);
}



<span class="comment">/* 将数字类型的IP地址转换成字符串类型的 */</span>
<span class="preprocessor">#define IPTOSBUFFERS    12</span>
<span class="preprocessor"></span><span class="keywordtype">char</span> *iptos(u_long in)
{
    <span class="keyword">static</span> <span class="keywordtype">char</span> output[IPTOSBUFFERS][3*4+3+1];
    <span class="keyword">static</span> <span class="keywordtype">short</span> which;
    u_char *p;

    p = (u_char *)&amp;in;
    which = (which + 1 == IPTOSBUFFERS ? 0 : which + 1);
    sprintf(output[which], <span class="stringliteral">"%d.%d.%d.%d"</span>, p[0], p[1], p[2], p[3]);
    <span class="keywordflow">return</span> output[which];
}

<span class="keywordtype">char</span>* ip6tos(<span class="keyword">struct</span> sockaddr *sockaddr, <span class="keywordtype">char</span> *address, <span class="keywordtype">int</span> addrlen)
{
    socklen_t sockaddrlen;

<span class="preprocessor">    #ifdef WIN32</span>
<span class="preprocessor"></span>    sockaddrlen = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_in6);
<span class="preprocessor">    #else</span>
<span class="preprocessor"></span>    sockaddrlen = <span class="keyword">sizeof</span>(<span class="keyword">struct </span>sockaddr_storage);
<span class="preprocessor">    #endif</span>
<span class="preprocessor"></span>

    <span class="keywordflow">if</span>(getnameinfo(sockaddr, 
        sockaddrlen, 
        address, 
        addrlen, 
        NULL, 
        0, 
        NI_NUMERICHOST) != 0) address = NULL;

    <span class="keywordflow">return</span> address;
}


</pre></div><p>
<a class="el" href="group__wpcap__tut1.html">&lt;&lt;&lt; 上一页</a> <a class="el" href="group__wpcap__tut3.html">下一页 &gt;&gt;&gt;</a> 
<hr>
<p align="right"><img border="0" src="winpcap_small.gif" align="absbottom" width="91" height="27">
documentation. Copyright (c) 2002-2005 Politecnico di Torino. Copyright (c) 2005-2007 
CACE Technologies. All rights reserved.
<br>2007 Translated By <a href="http://www.CoffeeCat.net.cn" target="_blank">CoffeeCat Studio</a>
</p>
