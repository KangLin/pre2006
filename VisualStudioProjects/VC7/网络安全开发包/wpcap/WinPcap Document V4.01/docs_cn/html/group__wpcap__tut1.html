<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>WinPcap: 获取设备列表</title>
<link href="style.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.1 -->
<!-- Translation(Chinese) By CoffeeCat -->
<!-- http://www.CoffeeCat.net.cn-->
<div class="tabs">
  <ul>
    <li id="current"><a href="main.html"><span>主 页</span></a></li>
    <li><a href="modules.html"><span>模块</span></a></li>
    <li><a href="annotated.html"><span>数据结构</span></a></li>
    <li><a href="files.html"><span>文件</span></a></li>
    <li><a href="pages.html"><span>相关页面</span></a></li>
  </ul></div>
<h1>获取设备列表</h1><table border="0" cellpadding="0" cellspacing="0">
<tr><td></td></tr>
</table>
通常，编写基于WinPcap应用程序的第一件事情，就是获得已连接的网络适配器列表。libpcap和WinPcap都提供了 <a class="el" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex()</a> 函数来实现这个功能: 这个函数返回一个 <a class="el" href="structpcap__if.html">pcap_if</a> 结构的链表， 每个这样的结构都包含了一个适配器的详细信息。值得注意的是，数据域 <em>name</em> 和 <em>description</em> 表示一个适配器名称和一个可以让人们理解的描述。<p>
下列代码能获取适配器列表，并在屏幕上显示出来，如果没有找到适配器，将打印错误信息。<p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">#include "pcap.h"</span>

main()
{
    <a class="code" href="structpcap__if.html">pcap_if_t</a> *alldevs;
    <a class="code" href="structpcap__if.html">pcap_if_t</a> *d;
    <span class="keywordtype">int</span> i=0;
    <span class="keywordtype">char</span> errbuf[<a class="code" href="group__wpcap__def.html#gcd448353957d92c98fccc29e1fc8d927">PCAP_ERRBUF_SIZE</a>];
    
    <span class="comment">/* 获取本地机器设备列表 */</span>
    <span class="keywordflow">if</span> (<a class="code" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex</a>(<a class="code" href="group__remote__source__string.html#g6d7103b8a7e1eca8c325bd8f32c361c3">PCAP_SRC_IF_STRING</a>, NULL <span class="comment">/* auth is not needed */</span>, &amp;alldevs, errbuf) == -1)
    {
        fprintf(stderr,<span class="stringliteral">"Error in pcap_findalldevs_ex: %s\n"</span>, errbuf);
        exit(1);
    }
    
    <span class="comment">/* 打印列表 */</span>
    <span class="keywordflow">for</span>(d= alldevs; d != NULL; d= d-&gt;<a class="code" href="structpcap__if.html#81508e6e4e41ca4235c8d6b51913c536">next</a>)
    {
        printf(<span class="stringliteral">"%d. %s"</span>, ++i, d-&gt;<a class="code" href="structpcap__if.html#5ac083a645d964373f022d03df4849c8">name</a>);
        if (d-&gt;<a class="code" href="structpcap__if.html#8444d6e0dfe2bbab0b5e7b24308f1559">description</a>)
            printf(<span class="stringliteral">" (%s)\n"</span>, d-&gt;<a class="code" href="structpcap__if.html#8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);
        <span class="keywordflow">else</span>
            printf(<span class="stringliteral">" (No description available)\n"</span>);
    }
    
    <span class="keywordflow">if</span> (i == 0)
    {
        printf(<span class="stringliteral">"\nNo interfaces found! Make sure WinPcap is installed.\n"</span>);
        <span class="keywordflow">return</span>;
    }

    <span class="comment">/* 不再需要设备列表了，释放它 */</span>
    <a class="code" href="group__wpcapfunc.html#g346b4b0b7fd1cda4abb9a39f767dbeb1">pcap_freealldevs</a>(alldevs);
}
</pre></div><p>
有关这段代码的一些说明<p>
首先， <a class="el" href="group__wpcapfunc.html#g98f36e62c95c6ad81eaa8b2bbeb8f16e">pcap_findalldevs_ex()</a> ，和其他libpcap函数一样，有一个 <em>errbuf</em> 参数。一旦发生错误，这个参数将会被libpcap写入字符串类型的错误信息。<p>
第二要记住，不是所有的操作系统都支持libpcap提供的网络程序接口，因此，如果我们想编写一个可移植的应用程序，我们就必须考虑在什么情况下， <em>description</em> 是 null。本程序中，我们遇到这种情况时，会打印提示语句"No description available"。
<p>
最后要记住，当我们完成了设备列表的使用，我们要调用 <a class="el" href="group__wpcapfunc.html#g346b4b0b7fd1cda4abb9a39f767dbeb1">pcap_freealldevs()</a> 函数将其占用的内存资源释放。
<p>
让我们编译并运行我们的第一个示例程序吧！ 为了能在Unix或Cygwin平台上编译这段程序，需要简单输入：<p>
<pre>
  gcc -o testprog testprog.c -lpcap
</pre><p>
在Windows平台上，您需要创建一个工程，并按照 <a class="el" href="group__wpcapsamps.html">使用WinPcap编程</a> 里的步骤做。 然而，我们建议您使用WinPcap developer's pack ( 详情请访问WinPcap网站, <a href="http://www.winpcap.org">http://www.winpcap.org</a> ), 因为它提供了很多已经配置好的范例，包括本教程中的所有示例代码，以及在编译运行时需要的 <em>包含文件(include)</em> 和 <em>库(libraries)</em> <p>
jiash假设我们已经完成了对程序的编译，那让我们来运行它吧。在某台WinXP的电脑上，我们得到的结果是：<p>
<pre>
   1. \Device\NPF_{4E273621-5161-46C8-895A-48D0E52A0B83} (Realtek RTL8029(AS) Ethernet Adapter)
   2. \Device\NPF_{5D24AE04-C486-4A96-83FB-8B5EC6C7F430} (3Com EtherLink PCI) 
</pre><p>
正如您看到的，Windows平台下的网络适配器的名字读起来相当容易，可见，解释性的描述是多么有帮助阿！<p>
<a class="el" href="group__wpcap__tut.html">&lt;&lt;&lt; 上一页</a> <a class="el" href="group__wpcap__tut2.html">下一页 &gt;&gt;&gt;</a> 
<hr>
<p align="right"><img border="0" src="winpcap_small.gif" align="absbottom" width="91" height="27">
documentation. Copyright (c) 2002-2005 Politecnico di Torino. Copyright (c) 2005-2007 
CACE Technologies. All rights reserved.
<br>2007 Translated By <a href="http://www.CoffeeCat.net.cn" target="_blank">CoffeeCat Studio</a>
</p>
